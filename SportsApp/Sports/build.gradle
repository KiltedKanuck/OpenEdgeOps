/*
 * This file was generated by the Gradle 'init' task.
 *
 * This is a general purpose Gradle build.
 * Learn more about Gradle by exploring our samples at https://docs.gradle.org/7.3.3/samples
 * This project uses @Incubating APIs which are subject to change.
 */
plugins {
    id("progress.openedge.abl-base") version "2.2.1"
    id("base")
}

// Gather required variables
def stgEnv = System.getProperty("STAGE_ENVIRONMENT")
def STAGE_ENVIRONMENT = stgEnv != null ? stgEnv : System.getenv("STAGE_ENVIRONMENT")

println "DLC: ${abl.dlcHome}"
println "Stage Environment: ${STAGE_ENVIRONMENT}"


// WEB App tasks
task compileWebApp(type: ABLCompile){
    source "PASOEContent/WEB-INF/openedge"
    propath "PASOEContent/WEB-INF/openedge"
    include "**/*.cls"
    include "**/*.p"
    rcodeDir = "${buildDir}/rcode/PASOEContent/WEB-INF/openedge"
}

task packageWebApp(type: OEWar){
    webAppName = "Sports"
    projectLocation = project.rootDir
    println "projectLocation: ${projectLocation.get()}"
    verbose = true
    destinationDirectory = project.distsDirectory

    // exclude generated folders;
    // because the ANT task used internally adds everything under the PASOEContent folder
    // exclude "**/${buildDir.name}/**"
    // exclude "**/output/**"

    // exclude Sources from 'openedge' directory
    // (the ANT task used internally does it by default but added here anyway)
    exclude "PASOEContent/WEB-INF/openedge/*.cls"
    exclude "PASOEContent/WEB-INF/openedge/*.p"
    exclude "PASOEContent/WEB-INF/openedge/*.i"

    webInf {
        from("${buildDir}/rcode/PASOEContent/WEB-INF/openedge")
        into("openedge")
    }

    manifest {
        attributes "Implementation-Title": "My Sports ABL Web Application"
        attributes "Implementation-Version": "1.0.0"
        // from ("PASOEContent/META-INF/MANIFEST.MF")
    }
}
packageWebApp.dependsOn "compileWebApp"

// ABL App tasks
task createSports2020(type: CreateDB){
	dbName = 'sports'
	sourceDb = "${dlcHome}/sports2020"
	outputDir = "${buildDir}/db/sports2020"
}

task compileABLApp(type: ABLCompile){
    source "AppServer"
    propath "AppServer","${dlcHome}/tty/OpenEdge.BusinessLogic.pl"
    include "**/*.cls"
    include "**/*.p"
    rcodeDir = "${buildDir}/rcode/AppServer"

    if (STAGE_ENVIRONMENT == "prod" || STAGE_ENVIRONMENT == "staging") {
        dbConnection {
            parameterFile='conf/startup.pf'
        }
    } else {
        dbConnection {
            dbName="${buildDir}/db/sports2020/sports"
            connectionParameters = "-1"
        }
    }

}
if (STAGE_ENVIRONMENT != "prod" || STAGE_ENVIRONMENT == "staging") {
    compileABLApp.dependsOn "createSports2020"
}

task packageABLApp(type: Oear){
    ablAppName = "Sports"
    destinationDirectory = project.distsDirectory  //will create 'Sports.oear' file at this location
    tlr { 
        from 'tlr'
        include '**/*.properties'
        include '**/*.xml'
    }
    webapps { 
        from project.distsDirectory
        include '**/*.war'
        include '**/*.zip'
    }
    openedge {
        from "${buildDir}/rcode/AppServer"
        include '**/*.r'
    }
    conf {
        from 'conf'
        exclude '**/*.MF'   //exclude direct copy of manifest file and append using manifest section
    }
    manifest {
        attributes "Implementation-Title": "My Sports ABL Application"
        attributes "Implementation-Version": "1.0.0"
        // from ("conf/MANIFEST.MF")
    }
}
packageABLApp.dependsOn "compileABLApp"
packageABLApp.dependsOn "packageWebApp"
build.dependsOn "packageABLApp"